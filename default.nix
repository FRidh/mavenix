{ pkgs ? import <nixpkgs> {} }: with pkgs;

let
  name = "mvnix";
  version = "0.1.0";
  gen-header = "# This file has been generated by ${name} ${version}.";

  default-tmpl = writeText "default-tmpl.nix" ''
    ${gen-header} Configure the build here!
    { pkgs ? import <nixpkgs> { inherit system; }
    , system ? builtins.currentSystem
    , mavenix ? pkgs.callPackage (import ./%%env%%) {}
    , doCheck ? false
    }: mavenix {
      inherit doCheck;
      src = ./%%src%%;
      infoFile = ./%%info%%;%%settings%%
    }
  '';
in stdenv.mkDerivation {
  inherit name;
  src = ./.;
  buildInputs = [ makeWrapper ];
  installPhase = ''
    mkdir -p $out/bin
    cp mvnix-init mvnix-update $out/bin
    wrapProgram $out/bin/mvnix-init \
      --set CONFIG_TEMPLATE ${default-tmpl} \
      --set MAVENIX_SCRIPT  ${./mavenix.nix}
    wrapProgram $out/bin/mvnix-update \
      --prefix PATH : ${lib.makeBinPath [ yq nix mktemp ]}
  '';
}
